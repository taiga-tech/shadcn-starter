# Changesets

Hello and welcome! This folder has been automatically generated by `@changesets/cli`, a build tool that works
with multi-package repos, or single-package repos to help you version and publish your code. You can
find the full documentation for it [in our repository](https://github.com/changesets/changesets)

We have a quick list of common questions to get you started engaging with this project in
[our documentation](https://github.com/changesets/changesets/blob/main/docs/common-questions.md)

# Changesets 完全ガイド

Changesetsは、Atlassianが開発したJavaScript/TypeScriptプロジェクト向けのバージョニング・チェンジログ管理ツールです。特に**monorepo（複数パッケージ）** 環境での優れた機能により、Emotion、Chakra UI、Astro、SvelteKitなど多くの主要プロジェクトで採用されています。

## Changesetsとは何か

Changesetsは「**変更の意図**」と「**実際の公開**」を分離する哲学に基づいて設計されています。従来のcommitメッセージベースのバージョニングとは異なり、開発者は専用の**changesetファイル**を作成して変更内容を記述します。これにより、チーム全体でのレビューや調整が可能になり、より正確で詳細なチェンジログを生成できます。

### 主な特徴

- **Monorepo特化設計**: 複数パッケージ間の依存関係を自動的に管理
- **セマンティックバージョニング**: patch、minor、majorの適切な自動判定
- **CI/CD統合**: GitHub Actionsとの seamless な連携
- **チーム協調**: PRでの変更レビューとチェンジログ管理

## インストールと初期セットアップ

### インストール方法

```bash
# npm
npm install --save-dev @changesets/cli

# yarn
yarn add --dev @changesets/cli

# pnpm（monorepoの場合）
pnpm add -Dw @changesets/cli
```

### 初期化

```bash
npx changeset init
```

この初期化により、以下のファイルが作成されます：

```
.changeset/
├── config.json     # 設定ファイル
└── README.md      # 使用方法の説明
```

### package.jsonにスクリプト追加

```json
{
    "scripts": {
        "changeset": "changeset",
        "version-packages": "changeset version",
        "release": "changeset publish"
    }
}
```

## 基本的な使用方法

### 1. Changesetの作成

開発中に変更を加えたら、changesetを作成します：

```bash
npx changeset
```

対話式プロンプトで以下を選択：

1. **影響を受けるパッケージ**の選択
2. **バージョンアップの種類**（patch/minor/major）
3. **変更内容の説明**

### 2. Changesetファイルの例

作成されるchangesetファイル（例：`.changeset/funny-dogs-jump.md`）：

```markdown
---
'@myorg/core': minor
'@myorg/utils': patch
---

新しいバリデーション機能を追加し、ユーティリティのバグを修正

- コアモジュールに包括的な入力バリデーションを導入
- 空配列処理時のnullポインタ例外を修正
- TypeScript定義を新しいバリデーションオプションに対応
```

### 3. バージョンアップとリリース

```bash
# 1. バージョンを更新（changesetを消費）
npx changeset version

# 2. 依存関係を更新
npm install

# 3. 変更をコミット
git add .
git commit -m "Version packages"

# 4. パッケージを公開
npx changeset publish
```

## Monorepo環境での使用方法

Changesetsは複数パッケージを持つmonorepoで真価を発揮します。

### パッケージ構造例

```
project-root/
├── .changeset/
├── packages/
│   ├── core/
│   │   ├── package.json
│   │   └── CHANGELOG.md
│   ├── utils/
│   │   ├── package.json
│   │   └── CHANGELOG.md
│   └── ui/
│       ├── package.json
│       └── CHANGELOG.md
└── package.json
```

### 依存関係の自動管理

パッケージAがパッケージBに依存している場合、Bがアップデートされると**Aも自動的にバージョンアップ**されます：

```json
// packages/ui/package.json
{
    "dependencies": {
        "@myorg/core": "^1.0.0" // 自動更新される
    }
}
```

### 固定パッケージとリンクパッケージ

**固定パッケージ**（常に同じバージョン）:

```json
{
    "fixed": [["@myorg/ui-core", "@myorg/ui-theme", "@myorg/ui-components"]]
}
```

**リンクパッケージ**（連動してバージョンアップ）:

```json
{
    "linked": [
        ["@myorg/client", "@myorg/server"],
        ["@myorg/utils-*"] // glob パターン対応
    ]
}
```

## 設定ファイル（.changeset/config.json）詳細

### 完全な設定例

```json
{
    "$schema": "https://unpkg.com/@changesets/config@3.1.1/schema.json",
    "changelog": ["@changesets/changelog-github", { "repo": "myorg/myrepo" }],
    "commit": false,
    "fixed": [],
    "linked": [],
    "access": "public",
    "baseBranch": "main",
    "updateInternalDependencies": "patch",
    "ignore": ["@myorg/private-package"],
    "bumpVersionsWithWorkspaceProtocolOnly": false,
    "snapshot": {
        "useCalculatedVersion": false,
        "prereleaseTemplate": null
    }
}
```

### 主要設定オプション

| オプション                   | 説明                   | 選択肢                                               |
| ---------------------------- | ---------------------- | ---------------------------------------------------- |
| `changelog`                  | チェンジログ生成方法   | `false` / `"@changesets/cli/changelog"` / GitHub連携 |
| `access`                     | npm公開アクセス        | `"restricted"` (private) / `"public"`                |
| `updateInternalDependencies` | 内部依存関係の更新方法 | `"patch"` / `"minor"` / `"major"`                    |
| `ignore`                     | 公開除外パッケージ     | パッケージ名の配列                                   |
| `baseBranch`                 | 基準ブランチ           | `"main"` / `"master"`                                |

### GitHub連携の設定

```json
{
    "changelog": [
        "@changesets/changelog-github",
        {
            "repo": "myorg/myrepo",
            "token": "process.env.GITHUB_TOKEN"
        }
    ]
}
```

これにより、チェンジログにPRリンクや貢献者情報が自動追加されます。

## CI/CD自動化の方法

### GitHub Actions設定

```yaml
# .github/workflows/release.yml
name: Release
on:
    push:
        branches: [main]

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
    release:
        name: Release
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install Dependencies
              run: npm ci

            - name: Build Packages
              run: npm run build

            - name: Create Release Pull Request or Publish
              id: changesets
              uses: changesets/action@v1
              with:
                  publish: npm run release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
```

### 必要なシークレット設定

- `GITHUB_TOKEN`: GitHubが自動提供
- `NPM_TOKEN`: npmの認証トークン（npm profile設定で生成）

### Changesets Botの設定

GitHub Appsで「Changeset Bot」をインストールすると、changesetが不足しているPRに自動コメントが追加されます。

## よく使用されるコマンド

### 基本コマンド

```bash
# Changesetを作成（対話式）
npx changeset

# 空のchangesetを作成（CI要件用）
npx changeset --empty

# 外部エディタで開く
npx changeset --open

# バージョンを更新
npx changeset version

# パッケージを公開
npx changeset publish

# ステータスを確認
npx changeset status
```

### 高度なコマンド

```bash
# プリリリースモードに入る
npx changeset pre enter beta

# プリリリースモードを終了
npx changeset pre exit

# スナップショットバージョンを作成
npx changeset version --snapshot

# 特定のタグで公開
npx changeset publish --tag beta

# OTP（2段階認証）付きで公開
npx changeset publish --otp 123456

# 詳細なステータス表示
npx changeset status --verbose

# JSONでステータス出力
npx changeset status --output status.json
```

## ベストプラクティス

### 開発フロー

1. **機能開発時**: PR作成時にchangesetも追加
2. **1つの論理的変更ごと**: changesetは1つの機能/修正に対して1つ
3. **明確な説明**: ユーザー向けの分かりやすい変更説明を記述
4. **全ての変更が対象ではない**: ドキュメント更新やテストのみの変更は不要

### チーム運用

```bash
# .github/workflows/changeset-check.yml
name: Changeset Check
on:
  pull_request:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npx changeset status
```

### よくある問題と解決方法

**問題**: Changesetを忘れがち
**解決**: Changeset Botのインストール、CI での changeset status チェック

**問題**: 複雑な依存関係管理
**解決**: Changesetsが自動で内部依存関係を管理

**問題**: バージョン競合
**解決**: 複数のchangesetは自動的に最高のsemverバンプに統合

**問題**: プリリリースの複雑さ
**解決**: `changeset pre` コマンドの段階的理解と練習

## 他のツールとの比較

### vs Semantic Release

| 項目                       | Changesets            | Semantic Release |
| -------------------------- | --------------------- | ---------------- |
| **モノレポ対応**           | ✅ ネイティブサポート | ❌ 限定的        |
| **手動制御**               | ✅ レビュー可能       | ❌ 完全自動      |
| **コミットメッセージ依存** | ❌ 分離されている     | ✅ 必須          |
| **チーム協調**             | ✅ 優秀               | △ 限定的         |

### vs Lerna

| 項目             | Changesets      | Lerna          |
| ---------------- | --------------- | -------------- |
| **保守性**       | ✅ 活発に開発中 | ❌ レガシー    |
| **設定の簡単さ** | ✅ シンプル     | ❌ 複雑        |
| **CI/CD統合**    | ✅ 現代的       | △ 限定的       |
| **依存関係管理** | ✅ 自動         | △ 手動設定必要 |

### 使い分けの指針

**Changesetsを選ぶべき場合**:

- Monorepoプロジェクト
- チームでの手動制御が必要
- 詳細なチェンジログが重要
- JavaScript/TypeScript プロジェクト

**他のツールを選ぶべき場合**:

- 単一パッケージ（Release-it）
- 完全自動化が必要（Semantic-Release）
- 非npm エコシステム

## 実際のプロジェクト例

### 主要な採用事例

**Emotion**: CSS-in-JSライブラリ

```bash
# 複数パッケージの協調リリース
@emotion/react@11.0.0
@emotion/styled@11.0.0
@emotion/core@11.0.0
```

**Chakra UI**: コンポーネントライブラリ

```bash
# デザインシステム全体の統一バージョニング
@chakra-ui/react@2.0.0
@chakra-ui/theme@2.0.0
@chakra-ui/system@2.0.0
```

### 実際のワークフロー例

**開発者のワークフロー**:

```bash
# 1. 機能開発
git checkout -b feature/new-validation

# 2. コード変更後、changesetを作成
npx changeset
# → "Add input validation to core module"

# 3. PR作成・レビュー
git add .
git commit -m "Add validation feature"
git push
```

**メンテナーのワークフロー**:

```bash
# 1. PRマージ後、リリース準備
npx changeset version
# → package.json と CHANGELOG.md が更新

# 2. 確認・コミット
git add .
git commit -m "Version packages"

# 3. 公開
npx changeset publish
# → npm に公開、git tag 作成
```

### プリリリースワークフロー

```bash
# ベータ版開発開始
npx changeset pre enter beta

# 通常の開発フロー
npx changeset
npx changeset version  # → 1.0.0-beta.0
npx changeset publish --tag beta

# ベータ終了
npx changeset pre exit
npx changeset version  # → 1.0.0
npx changeset publish
```

## 高度な使用例

### 複数レジストリへの公開

```yaml
- name: Publish to NPM
  run: |
      echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc
      npx changeset publish
  env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

- name: Publish to GitHub Packages
  run: |
      echo "//npm.pkg.github.com/:_authToken=$GITHUB_TOKEN" > ~/.npmrc
      npx changeset publish --registry https://npm.pkg.github.com
```

### カスタムチェンジログ

```json
{
    "changelog": [
        "./custom-changelog.js",
        {
            "includeCommitHash": true,
            "includePRLinks": true
        }
    ]
}
```
